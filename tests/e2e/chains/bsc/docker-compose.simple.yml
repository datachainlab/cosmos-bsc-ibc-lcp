version: "3.8"

volumes:
  toki-bsc-rpc:
  toki-bsc-validator1:
  toki-bsc-validator2:
  toki-bsc-validator3:
  toki-bsc-validator4:

services:
  toki-bsc-bootstrap-simple:
    image: toki-bsc-geth-bootstrap:${GIT_CHECKOUT_BRANCH:-latest}
    container_name: toki-bsc-bootstrap
    env_file: .env
    environment:
      BLOCKS_PER_EPOCH: ${BSC_BLOCKS_PER_EPOCH:-200}
      INIT_HOLDER_BALANCE: "500000000000000000000"
      NUMS_OF_VALIDATOR: 4
      INIT_NUM_OF_CABINETS: 3
    volumes:
      - toki-bsc-rpc:/root/storage/bsc-rpc
      - toki-bsc-validator1:/root/storage/bsc-validator1
      - toki-bsc-validator2:/root/storage/bsc-validator2
      - toki-bsc-validator3:/root/storage/bsc-validator3
      - toki-bsc-validator4:/root/storage/bsc-validator4
      - ./scripts:/root/scripts
      - ./config:/root/config
      - ./init-holders:/root/init-holders
    networks:
      - toki-local-bsc
    command: /root/scripts/bootstrap.sh

  toki-bsc-rpc: # This is the bootstrap node
    image: toki-bsc-geth:${GIT_CHECKOUT_BRANCH:-latest}
    container_name: toki-bsc-rpc
    env_file: .env
    ports:
      - 8545:8545
    environment:
      NODE_ID: bsc-rpc
      VERBOSE: 3
    volumes:
      - toki-bsc-rpc:/root/.ethereum
      - ./scripts:/scripts
      - ./config:/config
    networks:
      - toki-local-bsc
    healthcheck:
      test: ["CMD", "/scripts/healthcheck.sh"]
      interval: 3s
      timeout: 5s
      retries: 30
    command: ash /scripts/bsc-rpc.sh

  toki-bsc-validator1:
    image: toki-bsc-geth:${GIT_CHECKOUT_BRANCH:-latest}
    container_name: toki-bsc-validator1
    env_file: .env
    environment:
      NODE_ID: bsc-validator1
      BOOTSTRAP_HOST: toki-bsc-rpc
    volumes:
      - toki-bsc-validator1:/root/.ethereum
      - ./scripts:/scripts
    networks:
      - toki-local-bsc
    command: ash /scripts/bsc-validator.sh

  toki-bsc-validator2:
    image: toki-bsc-geth:${GIT_CHECKOUT_BRANCH:-latest}
    container_name: toki-bsc-validator2
    env_file: .env
    environment:
      NODE_ID: bsc-validator2
      BOOTSTRAP_HOST: toki-bsc-rpc
    volumes:
      - toki-bsc-validator2:/root/.ethereum
      - ./scripts:/scripts
    networks:
      - toki-local-bsc
    command: ash /scripts/bsc-validator.sh

  toki-bsc-validator3:
    image: toki-bsc-geth:${GIT_CHECKOUT_BRANCH:-latest}
    container_name: toki-bsc-validator3
    env_file: .env
    environment:
      NODE_ID: bsc-validator3
      BOOTSTRAP_HOST: toki-bsc-rpc
    volumes:
      - toki-bsc-validator3:/root/.ethereum
      - ./scripts:/scripts
    networks:
      - toki-local-bsc
    command: ash /scripts/bsc-validator.sh

  toki-bsc-validator4:
    image: toki-bsc-geth:${GIT_CHECKOUT_BRANCH:-latest}
    container_name: toki-bsc-validator4
    env_file: .env
    environment:
      NODE_ID: bsc-validator4
      BOOTSTRAP_HOST: toki-bsc-rpc
    volumes:
      - toki-bsc-validator4:/root/.ethereum
      - ./scripts:/scripts
    networks:
      - toki-local-bsc
    command: ash /scripts/bsc-validator.sh

networks:
  toki-local-bsc:
    name: toki-local-bsc
    ipam:
      driver: default
      config:
        - subnet: 99.99.0.0/16
